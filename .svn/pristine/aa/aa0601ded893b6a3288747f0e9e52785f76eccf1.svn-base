$(document).ready(function(e) {
    var arr = [];
    arr[8] = '';
    arr[9] = '';
    arr[11] = '';
    arr[12] = '';
    arr[13] = '';
    arr[14] = '';
    $.datetimepicker.setLocale('ch')
    //轮询刷新
    setInterval(function(){
        var action = localStorage["systemAction"];
        if( action == 'refresh' ){
            localStorage['systemAction'] = 'active';
            $(".voucherTable li.reqOn").trigger("click")
        }
    },1000);

    $(".voucherTable ul li").click(function(){

        arr[14] = $("#statusInput").val()

        arr[14] = $("#statusInput").val()
        if(arr[14] == "PARTIAL_RECEIPT"){
            arr[13] = "INVENTORY_TRANSFER"
        }else{
            arr[13] = '';
            if( $("#status").children("abbr").html() =="全部" ){

            }else{
                arr[13] = $("#typeInput").val();
            }
        }


        if(arr[14] == "PARTIAL_RECEIPT2"){
            arr[14] = "PARTIAL_RECEIPT"
            arr[13] = "PURCHASE_INVENTORY_INSTOCK"
        }else{
            arr[13] = '';
            if( $("#status").children("abbr").html() =="全部" ){

            }else{
                arr[13] = $("#typeInput").val();
            }
        }

        if( $(this).html() == '待办事宜' ){
            ajaxPages('../web/api/inventory/getUnHandleBills','itemContainer_notHandled','holder_notHandled','inventory_notHandled',5,'','',arr);
        }
        if( $(this).html() == '已办事宜' ){
            ajaxPages('../web/api/inventory/getHandledBills','itemContainer_done','holder_done','inventory_done',5,'','',arr);
        }
        if( $(this).html() == '我的请求' ){
            ajaxPages('../web/api/inventory/getCreatedBills','itemContainer_myRequest','holder_myRequest','inventory_myRequest',5,'','',arr);
        }
        if( $(this).html() == '采购订单' ){
            arr[13] = ""
            arr[14] = $("#statusInput2").val()
            ajaxPages('../web/api/inventory/getPurchaseBillList','itemContainer_myPurchaseOrder','holder_purchase','purchaseOrder',5,'','',arr);
        }
    });
    //搜索
    $("#voucherSearch").click(function(){

        var checked = $(".reqOn").html();
        var code = $("#voucherOrder").val();
        var creator = $("#voucherName").val();
        var start = $("#datetimepicker_start").val();
        var end = $("#datetimepicker_end").val();
        var billType = '';
        if( $("#type").children("abbr").html() != '全部' ){
            billType = $("#typeInput").val();
        }
        var billStatus = '';
        if( $("#status").children("abbr").html() =="全部" ){

        }else{
            billStatus = $("#statusInput").val();
        }
        var billStatus2 = '';
        if( $("#status2").children("abbr").html() =="全部" ){

        }else{
            billStatus2 = $("#statusInput2").val();
        }
        if(billStatus == "PARTIAL_RECEIPT"){
            billType = "INVENTORY_TRANSFER"
        }


        if(billStatus == "PARTIAL_RECEIPT2"){
            billStatus = "PARTIAL_RECEIPT"
            billType = "PURCHASE_INVENTORY_INSTOCK"
        }
        arr[8] = start;
        arr[9] = end;
        arr[11] = code;
        arr[12] = creator;
        arr[13] = billType;

        if( start > end ){
            response_ensure_alert("error","结束时间不得小于开始时间");
        }
        else{
            if( checked == '待办事宜' ){
                arr[14] = billStatus;
                ajaxPages('../web/api/inventory/getUnHandleBills','itemContainer_notHandled','holder_notHandled','inventory_notHandled',5,'','',arr);
            }
            else if( checked == '已办事宜' ){
                arr[14] = billStatus;
                ajaxPages('../web/api/inventory/getHandledBills','itemContainer_done','holder_done','inventory_done',5,'','',arr);
            }
            else if( checked ==  '我的请求'){
                arr[14] = billStatus;
                ajaxPages('../web/api/inventory/getCreatedBills','itemContainer_myRequest','holder_myRequest','inventory_myRequest',5,'','',arr);
            }
            else if( checked ==  '采购订单'){
                arr[14] = billStatus2;
                ajaxPages('../web/api/inventory/getPurchaseBillList','itemContainer_myPurchaseOrder','holder_purchase','purchaseOrder',5,'','',arr);
            }
        }

    });


    $(".voucherTable ul li[value='0']").trigger("click");


    $("#date_start").click(function(e){
        $("#datetimepicker_start").datetimepicker({
            step:5,
            lang:'ch',
            timepicker:false,
            format:'Y-m-d',
            formatDate:'Y-m-d'
        });
        $("#datetimepicker_start").trigger("focus");
    });
    $("#datetimepicker_start").blur(function(){
        $("#datetimepicker_start").datetimepicker('destroy');
    });
    $("#date_end").click(function(e){
        $("#datetimepicker_end").datetimepicker({
            step:5,
            lang:'ch',
            timepicker:false,
            format:'Y-m-d',
            formatDate:'Y-m-d'
        });
        $("#datetimepicker_end").trigger("focus");
    });
    $("#datetimepicker_end").blur(function(){
        $("#datetimepicker_end").datetimepicker('destroy');
    });

    $(".voucherTable li").click(function(){
        var lival=$(this).val();
        $(this).addClass("reqOn").siblings("li").removeClass("reqOn");
        if(lival==0){
            //待办事宜
            $(".myVoucherTodo").show().siblings("dl").hide();
            $(".billButton li:nth-child(2)").hide();
            $(".billButton li:nth-child(3)").show();
            $(".billButton li:nth-child(6)").show();
            $(".billButton li:nth-child(7)").show();
            $("#mergeReplenishment").show()
        }else if(lival==1){
            //已办事宜
            $(".myVoucherDone").show().siblings("dl").hide();
            $(".billButton li:nth-child(2)").hide();
            $(".billButton li:nth-child(3)").show();
            $(".billButton li:nth-child(6)").show();
            $(".billButton li:nth-child(7)").show();
            $("#mergeReplenishment").hide()
        }else if(lival==2){
            //我的请求
            $(".myVoucherRequest").show().siblings("dl").hide();
            $(".billButton li:nth-child(2)").hide();
            $(".billButton li:nth-child(3)").show();
            $(".billButton li:nth-child(6)").show();
            $(".billButton li:nth-child(7)").show();
            $("#mergeReplenishment").hide()
        }
        else if(lival==3){
            //采购订单
            $(".myPurchaseOrder").show().siblings("dl").hide();
            $(".billButton li:nth-child(2)").show();
            $(".billButton li:nth-child(3)").hide();
            $(".billButton li:nth-child(6)").hide();
            $(".billButton li:nth-child(7)").hide();
            $("#mergeReplenishment").hide()

        }
    });
    $(document).on("click",".vocherCode",function(){
        var vocherCode=$(this).siblings("input[type='hidden']").val();
        if($(".voucherTable li.reqOn").val()=="2"){
            $.post("../web/api/inventory/setBillRead",{
                billId:vocherCode,
                readFlag:true
            },function(data){
                if( data.response == 'success' ){


                }
                else{
                    response_ensure_alert('error',data.data.text,function(){

                    });
                }
            },'json');
            $(this).children("b").remove()
        }
    })
    $(document).on("click",".vocherCode",function(){
        var status = $(".reqOn").html();
        status = handleStatus(status)
        var vocherCode=$(this).siblings("input[type='hidden']").val();
        var vocherState=$(this).siblings(".vocherState").html();
       if(vocherState == "报损单" || vocherState == "报溢单" ){
           window.open("reimburse?id=" + vocherCode + "&status=" + status) ;
       }
        else if(vocherState == "补货单"  ){
            window.open("replenishment?id=" + vocherCode + "&status=" + status) ;
        }
       else if(vocherState == "补货单(合并单)" ){
           window.open("replenishmentMega2?parentId=" + vocherCode + "&status=" + status +  "&mega=" + 1) ;
       }
       else if(vocherState == "调拨单"  ){
           window.open("allocation?id=" + vocherCode + "&status=" + status) ;
       }
       else if(vocherState == "入库单"  ){
           window.open("storage?id=" + vocherCode + "&status=" + status) ;
       }
       else if(vocherState == "采购订单" ){
           window.open("purchaseOrder?purchaseId=" + vocherCode) ;
       }
       else if(vocherState == "采购入库单" ){
           window.open("inStorage?purchaseId=" + vocherCode + "&status=" + status) ;
       }
    });
    $(".arrowType").click(function(){
        var arr=$(this).val();
        $(this).siblings("dd").slideToggle();
        if(arr==0){
            $(this).css("background","url(../static/img/com_btn_arrow_black_up.png) center no-repeat");
            $(this).val("1")
        }else if(arr==1){
            $(this).css("background","url(../static/img/com_btn_arrow_black_down.png) center no-repeat");
            $(this).val("0")
        }

    });
    $(".arrowStatus").click(function(){
        var arr=$(this).val();

        if(arr==0){
            $(this).css("background","url(../static/img/com_btn_arrow_black_up.png) center no-repeat");
            $(this).val("1")
            $(".now").slideDown();
        }else if(arr==1){
            $(this).css("background","url(../static/img/com_btn_arrow_black_down.png) center no-repeat");
            $(this).val("0")
            $(".now").slideUp();
        }
        if($('.reqOn').val() != '3') {
            if ($('#typeInput').val() == 'INVENTORY_INSTOCK') {
                $(".billStatus").each(function () {
                    $(this).hide();
                })
                $("dd[data-typestr='FINISHED']").show();
            }
            else if ($('#typeInput').val() == 'PURCHASE_INVENTORY_INSTOCK') {
                $(".billStatus").each(function () {
                    $(this).hide();
                })
                $("dd[data-typestr='FINISHED']").show();
                $("dd[data-typestr='STAY_IN']").show();
                $("dd[data-typestr='PARTIAL_RECEIPT2']").show();
            }
            else {
                $(".billStatus").each(function () {
                    $(this).show();
                })
            }
        }
        else  if($('.reqOn').val() == '3') {
            $(".billStatus").each(function(){
                $(this).show();
            })
        }
    });


    $(".select dd").click(function(){
        var secval=$(this).html();
        var secStr=$(this).data("typestr");
        var type = $(this).parent().prev().html();
        $(this).hide().siblings("dd").hide();
        $(this).siblings("dt").children("abbr").html(secval);
        $(this).siblings("dt").children("input").val(secStr);
        $(this).siblings(".arrow").css("background","url(../static/img/com_btn_arrow_black_down.png) center no-repeat");

        if( secStr == 'REPLENISHMENT' ){
            console.log(1);
            $(".billStatus").each(function(){
                $(this).css("display","none");
                if( $(this).data("typestr") == 'CHECKING' || $(this).data("typestr") == 'CHECKED' || $(this).data("typestr") == 'TERMINATED' || $(this).data("typestr") == 'FINISHED' ){
                    $(this).show()
                    $(this).addClass("now");
                    $(".now").show()
                    $(".arrowStatus").css("background","url(../static/img/com_btn_arrow_black_up.png) center no-repeat");
                    $(".arrowStatus").val("1")
                }
                else{
                    $(this).removeClass("now");
                }
            });
        }
        else if( secStr == 'INVENTORY_TRANSFER' ){
            console.log(1);
            $(".billStatus").each(function(){
                $(this).css("display","none");
                if( $(this).data("typestr") == 'WAIT_DELIVERY' || $(this).data("typestr") == 'WAIT_RECEIVER' || $(this).data("typestr") == 'TERMINATED' || $(this).data("typestr") == 'FINISHED' || $(this).data("typestr") == 'WAIT_EDIT'){
                    $(this).show()
                    $(this).addClass("now");
                    $(".now").show()
                    $(".arrowStatus").css("background","url(../static/img/com_btn_arrow_black_up.png) center no-repeat");
                    $(".arrowStatus").val("1")
                }
                else{
                    $(this).removeClass("now");
                }
            });
        }
        else if( secStr == 'MORE_REPORT' || secStr == 'LESS_REPORT'){
            console.log(1);
            $(".billStatus").each(function(){
                $(this).css("display","none");
                if( $(this).data("typestr") == 'CHECKING' || $(this).data("typestr") == 'WAIT_EDIT' || $(this).data("typestr") == 'TERMINATED' || $(this).data("typestr") == 'FINISHED' ){
                    $(this).show()
                    $(this).addClass("now");
                    $(".now").show()
                    $(".arrowStatus").css("background","url(../static/img/com_btn_arrow_black_up.png) center no-repeat");
                    $(".arrowStatus").val("1")
                }
                else{
                    $(this).removeClass("now");
                }
            });
        }
        else if( secStr == 'MERGE_REPLENISHMENT'){
            console.log(1);
            $(".billStatus").each(function(){
                $(this).css("display","none");
                if( $(this).data("typestr") == 'CHECKING' || $(this).data("typestr") == 'WAIT_EDIT' || $(this).data("typestr") == 'TERMINATED' || $(this).data("typestr") == 'FINISHED' ){
                    $(this).show()
                    $(this).addClass("now");
                    $(".now").show()
                    $(".arrowStatus").css("background","url(../static/img/com_btn_arrow_black_up.png) center no-repeat");
                    $(".arrowStatus").val("1")
                }
                else{
                    $(this).removeClass("now");
                }
            });
        }
        else{
            //单据状态全部
            if( type == '单据类型' ){
                var btype = $(this).data("typesta-typestr");
                $('#typeInput').val($(this).data("typesta-typestr"));
                $(".All").css("display","block");
                $(".billStatus").each(function(){
                    $(this).addClass("now");
                    $(this).show()
                    $(".arrowStatus").css("background","url(../static/img/com_btn_arrow_black_up.png) center no-repeat");
                    $(".arrowStatus").val("1")
                    $(".now").show()
                });
                //入库单
                if(btype == 'INVENTORY_INSTOCK'  && $('.reqOn').val() != 3){
                    $("#statusInput").parent().parent().children('dd').each(function(){
                        $(this).hide();
                    })
                    $("dd[data-typestr='FINISHED']").show();

                }
                //采购入库单
                else if(btype == 'PURCHASE_INVENTORY_INSTOCK' && $('.reqOn').val() != 3){
                    $("#statusInput").parent().parent().children('dd').each(function(){
                        $(this).hide();
                    })
                    $("dd[data-typestr='FINISHED']").show();
                    $("dd[data-typestr='STAY_IN']").show();
                    $("dd[data-typestr='PARTIAL_RECEIPT2']").show();
                }
                else{
                    $(".billStatus").each(function(){
                        $(this).show();
                    })
                }
            }
        }

    });


});

function handleStatus( str ){
    if( str == '待办事宜' ){
        return 'nothandled';
    }
    if( str == '已办事宜' ){
        return 'done';
    }
    if( str == '我的请求' ){
        return 'myrequest';
    }
}


